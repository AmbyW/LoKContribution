<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LoK Contribution</title>
    <link rel="icon" type="image/png" sizes="96x96" href="https://www.leagueofkingdoms.com/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datepicker/1.0.10/datepicker.min.css" integrity="sha512-YdYyWQf8AS4WSB0WWdc3FbQ3Ypdm0QCWD2k4hgfqbQbRCJBEgX0iAegkl2S1Evma5ImaVXLBeUkIlP6hQ1eYKQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js" defer integrity="sha512-YUkaLm+KJ5lQXDBdqBqk7EVhJAdxRnVdT2vtCzwPHSweCzyMgYV/tgGF4/dCyqtCC2eCphz0lRQgatGVdfR0ww==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/1.0.11/jsrender.min.js" defer integrity="sha512-bKlNlbTH3duwZ28zoqEhXui/yuaPuQVci6OAVu0zh2WfYbEKD39HszVR8byP4/L4YyBo3b5CGIY+4ldVN93uCg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" defer integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" defer integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js" integrity="sha512-37T7leoNS06R80c8Ulq7cdCDU5MNQBwlYoy1TX/WUsLFC2eYNqtKlV0QjH7r8JpG/S0GUMZwebnVFLPd6SU5yg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/additional-methods.min.js" integrity="sha512-XZEy8UQ9rngkxQVugAdOuBRDmJ5N4vCuNXCh8KlniZgDKTvf7zl75QBtaVG1lEhMFe2a2DuA22nZYY+qsI2/xA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/localization/messages_es.min.js" integrity="sha512-Ou4GV0BYVfilQlKiSHUNrsoL1nznkcZ0ljccGeWYSaK2CaVzof2XaZ5VEm5/yE/2hkzjxZngQHVwNUiIRE8yLw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datepicker/1.0.10/datepicker.min.js" integrity="sha512-RCgrAvvoLpP7KVgTkTctrUdv7C6t7Un3p1iaoPr1++3pybCyCsCZZN7QEHMZTcJTmcJ7jzexTO+eFpHk4OCFAg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            background-image: url("https://www.dropbox.com/scl/fi/8enbqi0sidipy9aenyy51/field.png?rlkey=nnlpit9gnyribniv5mnr775r1&raw=1");
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;

            .col-md-10.offset-1 .card.mt-4 {
                background-color: rgba(240, 248, 255, 0.65);
            }
        }
    </style>

</head>
<body>
    <div class="container">
        <div class="row mb-5">
            <div class="">
                <a href="https://www.leagueofkingdoms.com">
                    <img src="https://www.leagueofkingdoms.com/img/logo.png" width="20%" alt="League of Kingdoms Logo">
                </a>
            </div>
        </div>
        <div class="col-md-10 offset-1">
            <div class="card mt-4">
                <form action="/get_contribution" method="get" id="getcontribution-form">
                    <div class="card-header text-center">
                        Datos para buscar la contribución
                    </div>
                    <div class="card-body">
                    <div class="row">
                        <div class="col-auto form-group">
                            <label for="kingdom_name" >Nombre del Reino <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="kingdom_name" placeholder="Nombre del Reino" name="kingdom_name">
                        </div>
                        <div class="col-auto form-group">
                            <label for="land_id" >ID de la Tierra <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="land_id" placeholder="ID de la Tierra" name="land_id">
                        </div>
                        <div class="col-auto form-group">
                            <label for="from" >Desde <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="from" placeholder="Desde" name="from">
                        </div>
                        <div class="col-auto form-group">
                            <label for="to" >Hasta <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="to" placeholder="Hasta" name="to">
                        </div>
                        <div class="col-12 mt-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="adjacent_lands" name="adjacent_lands" checked>
                                <label class="form-check-label" for="adjacent_lands">
                                    Agregar Datos de tierras adyacentes
                                </label>
                            </div>
                        </div>
                    </div>
                    </div>
                    <div class="card-footer text-center">
                        <button id="form_submit" type="submit" class="btn btn-primary mb-3">Ver contribución</button>
                        <button id="form_spinner" class="btn btn-primary mb-3 d-none" type="button" disabled>
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            Cargando datos...
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="row mt-5">
            <h2></h2>
            <div id="lands" class="contanier col-md-8 offset-2 d-none">
                <div class="row">
                    <div class="col-4 mt-2 mb-2">
                        <div class="card" id="1">
                            <div class="card-header text-center"><strong class="card-title">title</strong><br><span>444444</span></div>
                        </div>
                    </div>
                    <div class="col-4 mt-2 mb-2">
                        <div class="card" id="2">
                            <div class="card-header text-center"><strong class="card-title">title</strong><br><span>444444</span></div>
                        </div>
                    </div>
                    <div class="col-4 mt-2 mb-2">
                        <div class="card" id="3">
                            <div class="card-header text-center"><strong class="card-title">title</strong><br><span>444444</span></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4 mt-2 mb-2">
                        <div class="card" id="4">
                            <div class="card-header text-center"><strong class="card-title">title</strong><br><span>444444</span></div>
                        </div>
                    </div>
                    <div class="col-4 mt-2 mb-2">
                        <div class="card" id="5">
                            <div class="card-header text-center"><strong class="card-title">title</strong><br><span>444444</span></div>
                        </div>
                    </div>
                    <div class="col-4 mt-2 mb-2">
                        <div class="card" id="6">
                            <div class="card-header text-center"><strong class="card-title">title</strong><br><span>444444</span></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4 mt-2 mb-2">
                        <div class="card" id="7">
                            <div class="card-header text-center"><strong class="card-title">title</strong><br><span>444444</span></div>
                        </div>
                    </div>
                    <div class="col-4 mt-2 mb-2">
                        <div class="card" id="8">
                            <div class="card-header text-center"><strong class="card-title">title</strong><br><span>444444</span></div>
                        </div>
                    </div>
                    <div class="col-4 mt-2 mb-2">
                        <div class="card" id="9">
                            <div class="card-header text-center"><strong class="card-title">title</strong><br><span>444444</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="owners" class="row">
                <div class="table-responsive">

                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function() {
            let data = {"lands":[{"color":"#7F0cA7b","contribution":14.175000000000011,"land":143870,"owner":"0x7F0cA7bc35a0B45E25055fC1775631ADE7c082be","position":1},{"color":"#7F0cA7b","contribution":14.175000000000011,"land":143871,"owner":"0x7F0cA7bc35a0B45E25055fC1775631ADE7c082be","position":2},{"color":"#7F0cA7b","contribution":14.175000000000011,"land":143872,"owner":"0x7F0cA7bc35a0B45E25055fC1775631ADE7c082be","position":3},{"color":"#7F0cA7b","contribution":46.17499999999997,"land":144126,"owner":"0x7F0cA7bc35a0B45E25055fC1775631ADE7c082be","position":4},{"color":"#7F0cA7b","contribution":113.40000000000009,"land":144127,"owner":"0x7F0cA7bc35a0B45E25055fC1775631ADE7c082be","position":5},{"color":"#7F0cA7b","contribution":14.175000000000011,"land":144128,"owner":"0x7F0cA7bc35a0B45E25055fC1775631ADE7c082be","position":6},{"color":"#7F0cA7b","contribution":14.175000000000011,"land":144382,"owner":"0x7F0cA7bc35a0B45E25055fC1775631ADE7c082be","position":7},{"color":"#7F0cA7b","contribution":34.175000000000004,"land":144383,"owner":"0x7F0cA7bc35a0B45E25055fC1775631ADE7c082be","position":8},{"color":"#7F0cA7b","contribution":14.175000000000011,"land":144384,"owner":"0x7F0cA7bc35a0B45E25055fC1775631ADE7c082be","position":9}],"owners":[{"contribution":278.8000000000001,"wallet":"0x7F0cA7bc35a0B45E25055fC1775631ADE7c082be"}]}

            const paint_blocks = function (data) {
                $("#lands").removeClass("d-none");
                $("#lands .card").each(function (index) {
                    let founded = false;
                    for (let land of data) {
                        if (land.position === parseInt(this.id)) {
                            $(this).find("strong").text(land.land);
                            $(this).find("span").text(land.contribution.toFixed(4));
                            $(this).css("background-color", land.color);
                            founded = true;
                            break;
                        }
                    }
                    if(!founded) {
                        $(this).find("strong").text(" 000 ");
                        $(this).find("span").text(" 00");
                        $(this).css("background-color", "grey");
                        $(this).css("color", "grey");
                    }
                })
            }
            const full_table = function (data) {

                let html_table = '{% raw %}' +
                    '                   <table class="table table-success table-hover table-striped table-bordered">\n' +
                    '                        <thead>\n' +
                    '                            <tr>\n' +
                    '                                <th scope="col text-center">Owner</th>\n' +
                    '                                <th scope="col text-center">Contribution</th>\n' +
                    '                            </tr>\n' +
                    '                        </thead>\n' +
                    '                        <tbody>\n' +
                    '                            {{for owners}}' +
                    '                            <tr>\n' +
                    '                                <td>{{>wallet}}</td>\n' +
                    '                                <td>{{>contribution}} dvp</td>\n' +
                    '                            </tr>\n' +
                    '                            {{/for}}' +
                    '                        </tbody>\n' +
                    '                    </table>' +
                    '{% endraw %}';
                let tmpl = $.templates(html_table);
                let html_rendered = tmpl.render(data);
                $("#owners").removeClass("d-none");
                $("#owners .table-responsive").html(html_rendered);
            }

            const submit_button = $("#form_submit");
            const submit_spinner = $("#form_spinner")
            const enable_spinner = function () {
                submit_button.addClass("d-none");
                submit_spinner.removeClass("d-none");
            }
            const disable_spinner = function () {
                submit_button.removeClass("d-none");
                submit_spinner.addClass("d-none");
            }

            let form = $("#getcontribution-form");
            $("#from").datepicker({
                format: 'yyyy-mm-dd',
                endDate: "today",
            });
            $("#to").datepicker({
                format: 'yyyy-mm-dd',
                endDate: "today",
            });
            form.validate({
                errorClass: 'text-danger',
                rules: {
                    'kingdom_name': {
                        required: true,
                    },
                    'land_id': {
                        required: true,
                        digits: true,
                        min: 100000,
                        max: 165535,
                        maxlength: 6,
                        minlength: 6,
                    },
                    'from': {
                        required: true,
                    },
                    'to': {
                        required: true,
                    },
                },
            });
            form.on("submit", function (e) {
                e.preventDefault();
                if (!form.valid()) {
                    return;
                }
                let data = [];
                form.find('input,select').each(function() {
                    data.push({name: this.name, value: this.checked});
                });
                enable_spinner();
                form.ajaxSubmit({
                    type: "GET",
                    data: data,
                    success: function (response) {
                        disable_spinner();
                        paint_blocks(response.lands);
                        full_table(response);
                    },
                    error: function (errors) {
                        console.log(errors);
                        disable_spinner();
                    }
                })
            })
        })

    </script>
</body>
</html>